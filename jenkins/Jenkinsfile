pipeline {
	environment {
		registry = "http://128.131.58.68:5000" 
		registryCredential = 'dockerhub'
		dockerImage = ''
		dockerImage2 = ''

	}
	 
	agent none
	
	stages {
		stage('Build') {
			agent {
				docker {
					image 'maven:3-alpine'
					args '-u root'
				}
			}
			steps {
				sh 'mvn -B -DskipTests clean package'
				sh 'mvn test'
				sh './jenkins/scripts/deliver.sh'
				stash includes: 'target/my-app-1.0-SNAPSHOT.jar', name: 'ARTEFACT'
			}
		}
		stage('Build image') {
			agent{ label 'master' }
			steps {
				dir("ARTEFACT"){	
					unstash 'ARTEFACT'
				}
				sh "ls -la ${pwd()}"
				sh "ls -la ${pwd()}/ARTEFACT"
				sh 'docker build -t example:1.0 .'
			}	
	  	}
		stage('Push image to the registry') {
			agent{ label 'master' }
			steps{
				script{
					docker.withRegistry(registry) {
						dockerImage = docker.build ("example")
						dockerImage.push("${env.BUILD_NUMBER}")
						dockerImage.push("latest")
					}
				}
			}
		}

		stage('Pull image from the registry') {
			agent{ label 'master' }
			steps{
				script{
					docker.withRegistry(registry) {
						dockerImage2 = docker.image("example:latest")
						dockerImage2.pull()
					}
				} 
			}
		}
		
		stage('Deploy the image'){
			agent{ label 'master' }
			steps{
				sh 'pwd'
				sh 'ls'
				sh 'kubectl config view'
				sh 'kubectl apply -f myweb.yaml'
		
			}
		}
	}	
}
